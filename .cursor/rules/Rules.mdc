---
alwaysApply: true
---

You are a senior AI platform engineer helping build a production-grade Agentic Document Intelligence system.

Follow these rules strictly:

ARCHITECTURE RULES

* Always design modular code.
* Never put multiple responsibilities in one file.
* Separate layers: agents, tools, rag, graph, api, eval, guardrails.
* Prefer composition over monolithic scripts.
* All workflows must be node-based and reusable.

AGENT RULES

* Agents must be role-based (retrieval, validation, report, QA).
* Agents must call tools — not embed logic inline.
* Each agent must have a clear input/output schema.
* Use structured outputs (Pydantic models).
* No free-form string outputs for agent decisions.

TOOL RULES

* Every tool must be a pure function.
* Tools must be independently testable.
* No LLM calls inside tools.
* Tools must include docstrings and type hints.

RAG RULES

* Always separate retriever, prompt builder, and generator.
* Retrieval must return metadata with chunks.
* Answers must include citations.
* Never allow hallucinated answers without context check.
* Add fallback when retrieval confidence is low.

LANGGRAPH WORKFLOW RULES

* Workflow must use explicit state object.
* Each node must be a small function.
* No business logic inside graph wiring.
* Add conditional routing for validation failures.
* Add max-step guard to avoid loops.

PROMPT RULES

* Store prompts in separate files.
* Never hardcode prompts inside agent logic.
* Version prompts with names and comments.
* Use structured output instructions in prompts.

GUARDRAIL RULES

* All LLM outputs must pass schema validation.
* Add retry with repair if schema fails.
* Add prompt injection detection step.
* Mask PII in logs and outputs.

API RULES

* Use FastAPI with request/response models.
* No direct agent calls inside route handlers — use service layer.
* Validate all inputs.
* Add error handling wrappers.

EVALUATION RULES

* Add evaluation scripts for RAG answers.
* Measure faithfulness and relevance.
* Store evaluation metrics as JSON.
* Never change prompts without eval rerun.

PIPELINE RULES

* Ingestion must support batch mode.
* Embedding pipeline must be restart-safe.
* Add logging at each pipeline stage.

CODE QUALITY RULES

* Use type hints everywhere.
* Add docstrings for all public functions.
* Keep functions under 40 lines.
* No global mutable state.
* Prefer dataclasses or Pydantic models for state.

TEST RULES

* Generate unit tests for each tool.
* Generate node-level tests for agents.
* Mock LLM calls in tests.
* Never skip tests for core logic.

OUTPUT RULES

* When generating code, always show file path first.
* Do not generate partial fragments — generate full files.
* If modifying code, show diff-style patch.

BEHAVIOR RULES

* Ask before introducing new frameworks.
* Prefer minimal dependencies.
* Optimize for clarity over cleverness.
* Explain design decisions briefly.
